<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Arvin GPT Chat</title>
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050509;
      color: #e5e7eb;
      height: 100vh;
      display: flex;
    }

    /* ====== Sidebar ====== */
    .sidebar {
      width: 260px;
      background: #050509;
      border-right: 1px solid #27272f;
      display: flex;
      flex-direction: column;
    }

    .sidebar-top {
      padding: 10px;
      border-bottom: 1px solid #27272f;
    }

    .new-chat-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .new-chat-btn span.icon {
      font-size: 16px;
    }

    .sidebar-search {
      padding: 8px 10px;
    }

    .sidebar-search input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 6px 8px;
    }

    .conversation-item {
      padding: 8px 8px;
      margin: 2px 0;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conversation-item:hover {
      background: #111827;
    }

    .conversation-item.active {
      background: #1f2937;
    }

    .conversation-item .title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-item button.delete {
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 14px;
    }

    .sidebar-bottom {
      border-top: 1px solid #27272f;
      padding: 10px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* ====== Main chat area ====== */
    .chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
    }

    .chat-header {
      padding: 10px 20px;
      border-bottom: 1px solid #27272f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(12px);
      background: linear-gradient(to right, #020617cc, #02061799);
    }

    .chat-header-title {
      font-size: 15px;
      font-weight: 600;
    }

    .chat-header-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .messages {
      flex: 1;
      padding: 16px 20px 100px;
      overflow-y: auto;
    }

    .message-row {
      display: flex;
      margin-bottom: 12px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-bubble {
      padding: 8px 12px;
      border-radius: 14px;
      max-width: 720px;
      line-height: 1.5;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .message-row.user .message-bubble {
      background: #2563eb;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }

    .message-row.bot .message-bubble {
      background: #111827;
      color: #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    .message-bubble img {
      max-width: 100%;
      border-radius: 10px;
      display: block;
    }

    .message-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .message-row.bot .message-label {
      margin-left: 4px;
    }

    .message-row.user .message-label {
      margin-right: 4px;
      text-align: right;
    }

    /* ====== Input area ====== */
    .input-wrapper {
      position: fixed;
      left: 260px;
      right: 0;
      bottom: 0;
      padding: 8px 20px 16px;
      background: linear-gradient(to top, #020617, #020617f0, #02061700);
      border-top: 1px solid #27272f;
    }

    .input-area {
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }

    .input-area textarea {
      flex: 1;
      resize: none;
      min-height: 42px;
      max-height: 120px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    .input-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-buttons button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-send {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-draw {
      background: #10b981;
      color: #020617;
    }

    .btn-analyze {
      background: #4b5563;
      color: #e5e7eb;
    }

    .file-input {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    .file-input input[type="file"] {
      font-size: 11px;
      color: #e5e7eb;
    }

    .input-helper {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }

    .input-buttons button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    textarea:disabled {
      opacity: 0.7;
    }

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .input-wrapper {
        left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-top">
      <button class="new-chat-btn" id="new-chat-btn">
        <span class="icon">Ôºã</span>
        <span>‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà</span>
      </button>
    </div>

    <div class="sidebar-search">
      <input id="search-input" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ä‡∏ó..." />
    </div>

    <div class="conversation-list" id="conversation-list"></div>

    <div class="sidebar-bottom">
      <span>Arvin GPT</span>
      <span style="opacity:.7;">local chat</span>
    </div>
  </aside>

  <!-- Main chat -->
  <div class="chat-wrapper">
    <header class="chat-header">
      <div>
        <div class="chat-header-title" id="chat-header-title">‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà</div>
        <div class="chat-header-sub">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ Arvin ‚Äì ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå / ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ / ‡∏Ñ‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ</div>
      </div>
    </header>

    <main class="messages" id="messages"></main>
  </div>

  <!-- Input area (fixed bottom) -->
  <div class="input-wrapper">
    <form class="input-area" id="chat-form">
      <textarea id="user-input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
      <div class="input-buttons">
        <button type="submit" class="btn-send">‡∏™‡πà‡∏á</button>
        <button type="button" id="draw-btn" class="btn-draw">‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ</button>
        <button type="button" id="analyze-btn" class="btn-analyze">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ</button>
        <div class="file-input">
          <input type="file" id="image-input" accept="image/*" />
        </div>
      </div>
    </form>
    <div class="input-helper">
      Arvin ‡πÉ‡∏ä‡πâ /api/chat, /api/generate-image ‡πÅ‡∏•‡∏∞ /api/analyze-image ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    </div>
  </div>

  <script>
    // ====== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞ state ======
    const messagesEl = document.getElementById("messages");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("user-input");
    const drawBtn = document.getElementById("draw-btn");
    const analyzeBtn = document.getElementById("analyze-btn");
    const imageInput = document.getElementById("image-input");
    const newChatBtn = document.getElementById("new-chat-btn");
    const convoListEl = document.getElementById("conversation-list");
    const chatHeaderTitle = document.getElementById("chat-header-title");
    const searchInput = document.getElementById("search-input");

    const STORAGE_KEY = "arvin_conversations_v1";

    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: [{ id, title, messages: [{role, type, content}] }]
    let conversations = [];
    let currentConversationId = null;

    // ====== LocalStorage ======
    function loadConversations() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveConversations() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
    }

    function getCurrentConversation() {
      return conversations.find((c) => c.id === currentConversationId);
    }

    function createNewConversation() {
      const id = Date.now().toString();
      const convo = {
        id,
        title: "‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà",
        messages: [],
      };
      conversations.unshift(convo);
      currentConversationId = id;
      saveConversations();
      renderConversationList();
      renderMessages();
    }

    function setCurrentConversation(id) {
      currentConversationId = id;
      renderConversationList();
      renderMessages();
    }

    function updateConversationTitleFromFirstMessage(convo) {
      const first = convo.messages.find(
        (m) => m.role === "user" && m.type === "text"
      );
      if (!first) return;
      let t = first.content.replace(/^üé® ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ:\s*/,"").trim();
      if (t.length > 32) t = t.slice(0, 32) + "‚Ä¶";
      convo.title = t || "‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà";
    }

    // ====== UI Helpers ======
    function clearMessagesUI() {
      messagesEl.innerHTML = "";
    }

    function addTextMessage(text, role) {
      const row = document.createElement("div");
      row.classList.add("message-row", role === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.classList.add("message-bubble");
      bubble.textContent = text;

      const label = document.createElement("div");
      label.classList.add("message-label");
      label.textContent = role === "user" ? "‡∏Ñ‡∏∏‡∏ì" : "Arvin";

      if (role === "user") {
        row.appendChild(bubble);
        messagesEl.appendChild(row);
        bubble.insertAdjacentElement("beforebegin", label);
      } else {
        row.appendChild(bubble);
        messagesEl.appendChild(label);
        messagesEl.appendChild(row);
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addImageMessage(src, role) {
      const row = document.createElement("div");
      row.classList.add("message-row", role === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.classList.add("message-bubble");

      const img = document.createElement("img");
      img.src = src;
      bubble.appendChild(img);

      const label = document.createElement("div");
      label.classList.add("message-label");
      label.textContent = role === "user" ? "‡∏Ñ‡∏∏‡∏ì" : "Arvin";

      if (role === "user") {
        row.appendChild(bubble);
        messagesEl.appendChild(row);
        bubble.insertAdjacentElement("beforebegin", label);
      } else {
        row.appendChild(bubble);
        messagesEl.appendChild(label);
        messagesEl.appendChild(row);
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderMessages() {
      clearMessagesUI();
      const convo = getCurrentConversation();
      if (!convo) return;

      chatHeaderTitle.textContent = convo.title || "‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà";

      for (const msg of convo.messages) {
        if (msg.type === "image") {
          addImageMessage(msg.content, msg.role);
        } else {
          addTextMessage(msg.content, msg.role);
        }
      }
    }

    function renderConversationList() {
      const q = (searchInput.value || "").toLowerCase();
      convoListEl.innerHTML = "";
      conversations
        .filter((c) => !q || c.title.toLowerCase().includes(q))
        .forEach((convo) => {
          const item = document.createElement("div");
          item.classList.add("conversation-item");
          if (convo.id === currentConversationId) {
            item.classList.add("active");
          }

          const titleSpan = document.createElement("span");
          titleSpan.classList.add("title");
          titleSpan.textContent = convo.title || "‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà";

          const delBtn = document.createElement("button");
          delBtn.classList.add("delete");
          delBtn.textContent = "√ó";

          item.appendChild(titleSpan);
          item.appendChild(delBtn);
          convoListEl.appendChild(item);

          item.addEventListener("click", (e) => {
            if (e.target === delBtn) return;
            setCurrentConversation(convo.id);
          });

          delBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!confirm("‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°?")) return;
            conversations = conversations.filter((c) => c.id !== convo.id);
            if (currentConversationId === convo.id) {
              currentConversationId = conversations[0]?.id || null;
            }
            saveConversations();
            renderConversationList();
            renderMessages();
          });
        });
    }

    function setInputsDisabled(disabled) {
      input.disabled = disabled;
      drawBtn.disabled = disabled;
      analyzeBtn.disabled = disabled;
      imageInput.disabled = disabled;
      form.querySelector("button[type='submit']").disabled = disabled;
    }

    function buildMessagesForAPI(convo) {
      return convo.messages
        .filter(
          (m) =>
            m.type === "text" && (m.role === "user" || m.role === "assistant")
        )
        .map((m) => ({ role: m.role, content: m.content }));
    }

    // ====== API Calls ======
    async function callChatAPI() {
      const text = input.value.trim();
      if (!text) return;

      const convo = getCurrentConversation();
      if (!convo) return;

      const userMsg = { role: "user", type: "text", content: text };
      convo.messages.push(userMsg);
      updateConversationTitleFromFirstMessage(convo);
      saveConversations();
      renderConversationList();
      addTextMessage(text, "user");

      input.value = "";
      input.style.height = "42px";
      setInputsDisabled(true);

      try {
        const apiMessages = buildMessagesForAPI(convo);
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: apiMessages }),
        });

        const data = await res.json();
        if (data.reply) {
          const botText = data.reply.content;
          const botMsg = { role: "assistant", type: "text", content: botText };
          convo.messages.push(botMsg);
          saveConversations();
          addTextMessage(botText, "assistant");
        } else {
          addTextMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå", "assistant");
        }
      } catch (err) {
        console.error(err);
        addTextMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "assistant");
      } finally {
        setInputsDisabled(false);
      }
    }

    async function callDrawAPI() {
      const text = input.value.trim();
      if (!text) return;

      const convo = getCurrentConversation();
      if (!convo) return;

      const userText = "üé® ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ: " + text;
      const userMsg = { role: "user", type: "text", content: userText };
      convo.messages.push(userMsg);
      updateConversationTitleFromFirstMessage(convo);
      saveConversations();
      renderConversationList();
      addTextMessage(userText, "user");
      setInputsDisabled(true);

      try {
        const res = await fetch("/api/generate-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: text }),
        });

        const data = await res.json();
        if (data.imageBase64) {
          const src = "data:image/png;base64," + data.imageBase64;
          const botMsg = { role: "assistant", type: "image", content: src };
          convo.messages.push(botMsg);
          saveConversations();
          addImageMessage(src, "assistant");
        } else {
          addTextMessage("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "assistant");
        }
      } catch (err) {
        console.error(err);
        addTextMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "assistant");
      } finally {
        setInputsDisabled(false);
      }
    }

    async function callAnalyzeAPI() {
      const file = imageInput.files[0];
      if (!file) {
        alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
      }

      const convo = getCurrentConversation();
      if (!convo) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        const base64 = dataUrl.split(",")[1];

        const userImgMsg = { role: "user", type: "image", content: dataUrl };
        convo.messages.push(userImgMsg);
        saveConversations();
        addImageMessage(dataUrl, "user");
        setInputsDisabled(true);

        try {
          const res = await fetch("/api/analyze-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imageBase64: base64 }),
          });

          const data = await res.json();
          if (data.result) {
            const botMsg = {
              role: "assistant",
              type: "text",
              content: data.result,
            };
            convo.messages.push(botMsg);
            saveConversations();
            addTextMessage(data.result, "assistant");
          } else {
            addTextMessage("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "assistant");
          }
        } catch (err) {
          console.error(err);
          addTextMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "assistant");
        } finally {
          setInputsDisabled(false);
        }
      };
      reader.readAsDataURL(file);
    }

    // ====== Events ======
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      callChatAPI();
    });

    drawBtn.addEventListener("click", () => {
      callDrawAPI();
    });

    analyzeBtn.addEventListener("click", () => {
      callAnalyzeAPI();
    });

    newChatBtn.addEventListener("click", () => {
      createNewConversation();
    });

    searchInput.addEventListener("input", () => {
      renderConversationList();
    });

    // auto resize textarea
    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 120) + "px";
    });

    // ====== Init ======
    (function init() {
      conversations = loadConversations();
      if (!conversations.length) {
        createNewConversation();
      } else {
        currentConversationId = conversations[0].id;
        renderConversationList();
        renderMessages();
      }
      input.style.height = "42px";
    })();
  </script>
</body>
</html>
